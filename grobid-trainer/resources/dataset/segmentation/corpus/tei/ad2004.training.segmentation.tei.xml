<?xml version="1.0" ?>
<tei>
	<teiHeader>
		<fileDesc xml:id="_ad2004"/>
	</teiHeader>
	<text xml:lang="en">
			<front> Automatic differentiation: a tool for variational <lb/>data assimilation and adjoint sensitivity <lb/>analysis for flood modeling <lb/> W. Castaings  1  , D. Dartus  2  , M. Honnorat  3  , F.-X. Le Dimet  4  , Y. Loukili  5  , <lb/>and J. Monnier  6 <lb/> 1  INRIA/IDOPT william.castaings@imag.fr  񮽙 <lb/> 2  INPT – IMFT/HYDRE dartus@imft.fr <lb/> 3  INPG – INRIA/IDOPT marc.honnorat@imag.fr  񮽙񮽙 <lb/> 4  UJF – INRIA/IDOPT francois-xavier.le-dimet@imag.fr <lb/> 5  INRIA/IDOPT youssef.loukili@imag.fr  <lb/> 6  INPG – INRIA/IDOPT jerome.monnier@imag.fr <lb/></front>

			<body> 1 Introduction <lb/> Flooding is the result of complex interactions between the components of wa-<lb/>ter cycle and the forecast of such catastrophic events requires a completely <lb/>integrated approach (models and data) for the hydro-meteorological predic-<lb/>tion chain. The modeling of flood generation and propagation involves catch-<lb/>ment scale hydrology and river hydraulics. Actually, every model component <lb/>only leads to an approximation of the geophysical reality, since the underlying <lb/>physics formulation and the model inputs are all sources of uncertainty. Un-<lb/>derstanding, analysis and reduction of this uncertainty induce the following <lb/>issues: <lb/> • the sensitivity analysis is a key issue for providing physical insight into the <lb/>model dynamics. <lb/> • the initial and boundary conditions which are essential to mathematical <lb/>closure and drive the considered system, remain very difficult to estimate. <lb/> • the empirical parameters associated with model formulation must be cal-<lb/>ibrated or identified. <lb/> • the estimation of the systematic model error (correction term) could be <lb/>an additional prediction value. <lb/>A deterministic approach dealing with the aforementioned estimation and <lb/>sensitivity analysis problems results in the need of computing the derivatives <lb/> 񮽙  Work supported by the Pactes program funded by CNES  񮽙񮽙  Work supported by <lb/>a CNRS doctoral grant (BDI) co-funded by CNES.  񮽙񮽙񮽙  Post-doctoral work funded <lb/>by Région Rhône-Alpes ( &quot; Prévention numérique de crues &quot; project). <lb/>

			<page> 2 <lb/></page>

			<note place="headnote">C a s t a i n g s ,D a r t u s ,H o n n o r a t ,L eD i m e t ,L o u k i l i ,M o n n i e r <lb/></note> 
			
			of a function of model output variables with respect to input variables. Modern <lb/>automatic differentiation (ad) tools such as Tapenade [14, 9, 8] provide an <lb/>easier and safe way to fulfill this need. <lb/>Two applications are presented in this paper: variational data assimila-<lb/>tion [5, 1] and adjoint sensitivity analysis [2, 3]. <lb/> 2 The Adjoint Method <lb/> The evolution of the state of many time-dependent physical systems can be <lb/>described by a system of differential equations. For a given model, the value <lb/>of the state variable y is driven by the control variables which are potentially <lb/>all model inputs. For the general presentation of the adjoint method, we will <lb/>consider, as control variables, the initial condition u and a model parameter v: <lb/> 񮽙  ∂y <lb/> ∂t  (t) + A <lb/> 񮽙 <lb/> y(t), v <lb/> 񮽙 = 0 <lb/> ∀ t ∈]0, T ] <lb/> y(0) = u <lb/>, <lb/> (1) <lb/>where A is a partial differential operator which may be non-linear. Let φ be <lb/>a general objective function which depends on the control variables through <lb/>the state variable : <lb/> φ(u, v) = <lb/> 񮽙  T <lb/> 0 <lb/> ϕ <lb/> 񮽙 <lb/> y(u, v; t) <lb/> 񮽙 <lb/> dt , <lb/> (2) <lb/>where ϕ is a sufficiently smooth functional. The adjoint method makes it <lb/>possible to efficiently compute the partial derivatives of a function of the <lb/>model state variable with respect to control variables [10]. If p is defined as <lb/>the solution of the adjoint model <lb/>  <lb/> <lb/> <lb/> ∂p <lb/>∂t  (t) − <lb/> 񮽙 <lb/> ∂A <lb/>∂y <lb/> 񮽙 <lb/> y(t), v <lb/> 񮽙 񮽙  * <lb/> · p(t) =  ∂ϕ <lb/>∂y  (t) <lb/> ∀ t ∈ [0, T [ <lb/> p(T ) = 0 <lb/> , <lb/> (3) <lb/>then we obtain a simple expression of the partial derivatives of the functional: <lb/> ∂φ <lb/>∂u <lb/> (u, v) = −p(0) <lb/> and <lb/> ∂φ <lb/>∂v <lb/> (u, v) = <lb/> 񮽙  T <lb/> 0 <lb/> 񮽙 ∂A <lb/>∂v <lb/> 񮽙 <lb/> y(t), v <lb/> 񮽙 <lb/>񮽙  * <lb/> · p(t) dt . <lb/> All partial derivatives are calculated with a single forward integration of the <lb/>direct model (1) followed by a single backward integration of the adjoint <lb/>model (3). Another advantage of this method lies in the fact that the ho-<lb/>mogeneous part of the adjoint equations is independent of the functional ϕ. <lb/> In other words, the same model can be used to calculate the derivatives of <lb/>several functionals without major modifications. <lb/>The calculation of partial derivatives of a functional is useful in several <lb/>domains of flood simulation. Here, we are especially interested in two essen-<lb/>tial applications: variational data assimilation and adjoint sensitivity analysis. <lb/>

			<note place="headnote"> A tool for variational data assimilation and adjoint sensitivity analysis <lb/></note>

			<page>3 <lb/></page>

			Variational data assimilation consists in finding the control variables that min-<lb/>imize a cost function measuring the discrepancy between the state variable of <lb/>the model and data obtained from the observation of the physical system. An <lb/>efficient minimization of the cost function is carried out by using a descent <lb/>algorithm requiring the computation of its gradient. The adjoint sensitivity <lb/>analysis consists in determining the contribution of all model inputs to the <lb/>variation of a response function. Instead of performing finite difference approx-<lb/>imation of the gradient, requiring extensive direct model computations (brute <lb/>force method), a single run of the adjoint method provides all sensitivities. <lb/>Various applications of the adjoint method were investigated for environmen-<lb/>tal problems in the framework of the Idopt project [12, 13, 16, 17, 18]. <lb/>In practice, the numerical computation of the gradient of the functional <lb/> φ is performed by an implementation of the adjoint method which requires <lb/>the construction of an adjoint code. Since the best representation of the func-<lb/>tional is the associated computer code, it is better to use the adjoint of the <lb/>implementation of the direct model instead of the implementation of the con-<lb/>tinuous adjoint model to compute the exact value of the gradient. The use of <lb/>the ad tool Tapenade [14] makes it possible to save a lot of time in building <lb/>the adjoint code and prevents from many human errors. <lb/> 3 River Hydraulics <lb/> The forecast of floods requires an accurate modeling of river flows. The most <lb/>commonly used mathematical models for operational purposes in river hy-<lb/>draulics rely on the Shallow Water equations (swe). The two-dimensional swe <lb/> are derived from the three-dimensional Navier-Stokes equations by a vertical <lb/>integration under the hydrostatic assumption. In the conservative formulation, <lb/>the state variables are the water depth h and the discharge q = hu where u <lb/> is the depth-averaged velocity vector. If we consider a computational domain <lb/> Ω with a boundary Γ , the two-dimensional swe can be written as follows: <lb/>  <lb/>       <lb/>      <lb/> ∂  t  h + div(q ) = 0 <lb/>in Ω×]0, T ] <lb/> ∂  t  q + div <lb/> 񮽙  1 <lb/> h  q ⊗ q <lb/> 񮽙 +  1 <lb/>2  g񮽙h  2 <lb/> + gh񮽙z  b  + g <lb/> n  2  q񮽙q񮽙  2 <lb/> h  7/3 <lb/> = 0 <lb/>in Ω×]0, T ] <lb/> h(0) = h  0  , q(0) = q  0 <lb/> in Ω <lb/> (4) <lb/>where g is the magnitude of the gravity, z  b  the bed elevation, n the Manning <lb/>roughness coefficient, h  0  and q  0  the initial conditions. Moreover, we must add <lb/>boundary conditions. For an inlet Γ  in  , a discharge q  in  is imposed: <lb/> q  |Γ  in  (t) = q  in  (t) <lb/> ∀ t ∈ ]0, T ] . <lb/> (5) <lb/>

			<page> 4 <lb/></page>

			<note place="headnote"> C a s t a i n g s ,D a r t u s ,H o n n o r a t ,L eD i m e t ,L o u k i l i ,M o n n i e r <lb/></note>

			Concerning an outlet Γ  out  , we can either prescribe a water depth h  out  or impose <lb/>Neumann conditions: <lb/> h  |Γ  out  (t) = h  out  (t) ,  ∂u <lb/> ∂n  |  Γ out <lb/> (t) = 0 <lb/> ∀ t ∈ ]0, T ] <lb/>( 6 ) <lb/>or <lb/> ∂h <lb/>∂n  |  Γ out <lb/> (t) = 0 ,  ∂q <lb/>∂n  |  Γ out <lb/> (t) = 0 <lb/> ∀ t ∈ ]0, T ] <lb/>( 7 ) <lb/>The state of the flow is determined by the initial condition (Cauchy problem) <lb/>but also by the model parameters (z  b  and n) and the boundary conditions. <lb/>Actually, in order to carry out a simulation of a real flow, it is necessary to <lb/>have a good knowledge of these model inputs. However, they are incompletely <lb/>known in practice, and when an approximation is available, it is often sub-<lb/>ject to uncertainty. For example, the flood plain elevation is measured using <lb/>remote sensing techniques (photogrammetry, LIDAR) and bed elevation data <lb/>is made up of ground surveyed cross sections. The collected data consist in <lb/>a set of scattered points used to assign an elevation value to each computa-<lb/>tional grid point using interpolation techniques. Unfortunately, the raw data <lb/>is usually approximate, incomplete or sometimes simply missing. Moreover, <lb/>the interpolation induces additional numerical approximation. Other model <lb/>inputs cannot even be directly measured and should be defined thanks to <lb/>the modelers&apos; expertise. For example, the estimation of roughness is generally <lb/>based on land use classifications and empirical tables where a roughness co-<lb/>efficient is assigned to each land cover type. Besides, a model is never perfect <lb/>since it cannot take into account all the physics of the system, and its im-<lb/>plementation induces numerical approximations. Therefore, a simulation can <lb/>never reflect exactly the physical reality. However, it is possible to represent <lb/>some parts of the model errors by an additional term in the equations [16], <lb/>introducing new control variables. <lb/>Furthermore, some observations of the flow state may be available, such <lb/>as water depth, water level or velocity measurements. These should be in ac-<lb/>cordance with the simulation results. Therefore, the problem to be addressed <lb/>consists in identifying a set of control variables consistent with both the simu-<lb/>lation results and the hydraulic reality represented by observation data. Hence, <lb/> in flo w <lb/>ou tfl ow <lb/> h <lb/> z <lb/> 0 <lb/> b <lb/> Free surface <lb/>Water <lb/>Ground <lb/> Distance along the x−axis (m) <lb/>Height (m) <lb/> Fig. 1. One-dimensional vertical cut of the computational domain <lb/>

			<note place="headnote"> A tool for variational data assimilation and adjoint sensitivity analysis <lb/></note>

			<page>5 <lb/></page>

			we use variational data assimilation for the identification of initial and bound-<lb/>ary conditions, model parameters, bed elevation and for the evaluation of a <lb/>systematic model error. This method consists in minimizing a cost function <lb/>measuring the discrepancy between the state of the simulated flow and the <lb/>available observations of the real flow. The minimization is performed by a <lb/>limited memory quasi-Newton algorithm [7] which requires the computation of <lb/>the partial derivatives of the cost function with respect to the control variables <lb/>of the model. The derivatives are computed by the adjoint method requiring <lb/>the use of an adjoint code. <lb/>The swe (4) are solved using the finite volume method and the HLLC ap-<lb/>proximate Riemann solver [15, 11]. The direct program is written in Fortran 90 <lb/>and is made up of about 1600 lines of code. The adjoint code was obtained <lb/>thanks to the ad tool Tapenade [8]. The raw code produced by Tapenade <lb/> had to be manually modified to make it work properly. The adjoint of some <lb/>non-differentiable statements was rewritten and some unnecessary storage of <lb/>the state variable was removed. Before this optimization, the adjoint could <lb/>not run on a simple test case because the needed amount of memory was too <lb/>large (more than 2 gigabytes). After this optimization, the memory footprint <lb/>is only 16 megabytes and the ratio between the execution time of the adjoint <lb/>code and that of the direct code is about 3.5. <lb/>Two numerical experiments of data assimilation are presented. They ac-<lb/>tually consist of twin experiments, where observation data are computed by <lb/>the direct model with a set of known parameters. Then, a perturbation is <lb/>applied to the latter, modifying the simulation results. Afterwards, the vari-<lb/>ational data assimilation method is used to retrieve the original value of the <lb/>parameters. The same adjoint code is used in both experiments. <lb/>The first one concerns the identification of the bed elevation z  b  in a rect-<lb/>angular channel. The channel is 20.5 × 2 meters, the reference bed elevation is <lb/>defined by z  b  (x, y) = 0.2 −  1 <lb/> 20  (x − 10)  2  if x ∈ [8; 10] and z  b  (x, y) = 0 otherwise <lb/>for all y ∈ [0; 2]. A constant discharge q  in  of 2 m  3  s  −1  is imposed at the inlet <lb/>and a constant water depth h  out  of 0.6 meters is prescribed at the outlet. This <lb/>configuration leads to a steady flow featuring an hydraulic jump after the <lb/>bump. A vertical cut of the computational domain is plotted in Fig. 2. The <lb/>observations of the water depth h  obs  and the velocity u  obs  are created from <lb/> 0 <lb/> 0.2 <lb/>0.4 <lb/>0.6 <lb/>0.8 <lb/>1 <lb/>0 <lb/>5 <lb/>10 <lb/>15 <lb/>20 <lb/>Height (m) <lb/> Distance along x−axis (m) <lb/>bed <lb/>free surface <lb/> inflow <lb/> B <lb/> E <lb/>D <lb/> h <lb/> Fig. 2. Rectangular channel with a bump: vertical cut of the computational domain <lb/>

			<page> 6 <lb/></page>

			<note place="headnote">C a s t a i n g s ,D a r t u s ,H o n n o r a t ,L eD i m e t ,L o u k i l i ,M o n n i e r <lb/> </note>
			
			this reference configuration: they are defined as equal to the state variables of <lb/>the steady flow for each computational point. It should be noted that in this <lb/>case, the observation data is time-independent. However, nothing prevents us <lb/>from using observations varying in time. <lb/>A simulation is carried out with a modified configuration over a period <lb/>of T = 3 seconds: a flat bed defined by z  b  ≡ 0 is used with the reference <lb/>steady state as an initial condition. As a result, the water flow is disrupted and <lb/>becomes unsteady. In order to use the variational data assimilation method to <lb/>retrieve the reference bed elevation, we introduce the following cost function: <lb/> j  1  (z  b  ) = <lb/>1 <lb/>2 <lb/> 񮽙  T <lb/> 0 <lb/> 񮽙 񮽙 <lb/>񮽙 h(t) − h  obs  (t) <lb/> 񮽙 <lb/>񮽙  2 <lb/> Ω <lb/> + <lb/> 񮽙 <lb/>񮽙 u(t) − u  obs  (t) <lb/> 񮽙 <lb/>񮽙  2 <lb/> Ω <lb/> 񮽙 <lb/> dt . <lb/> (8) <lb/>The gradient of this cost function is computed with the adjoint code and is <lb/>used as an input for the minimization algorithm. In Fig. 3 (a), the cost function <lb/>and the norm of its gradient, both normalized by their initial value, are plotted <lb/>against the number of iterations of the minimization process. Figure 3 (b) <lb/>shows the bed elevation for several steps of the minimization process. We <lb/> 1e−08 <lb/> 1e−07 <lb/>1e−06 <lb/>1e−05 <lb/>1e−04 <lb/>0.001 <lb/>0.01 <lb/>0.1 <lb/>1 <lb/>0 <lb/>10 <lb/>20 <lb/>30 <lb/>40 <lb/>50 <lb/>60 <lb/>70 <lb/>80 <lb/>90 <lb/>100 <lb/>Number of iterations <lb/>j <lb/>| ∇j | <lb/> −0.05 <lb/> 0 <lb/>0.05 <lb/>0.1 <lb/>0.15 <lb/>0.2 <lb/>0 <lb/>5 <lb/>10 <lb/>15 <lb/>20 <lb/>Height (m) <lb/> Distance along x−axis (m) <lb/>initial bed <lb/>iteration #4 <lb/>iteration #8 <lb/>iteration #12 <lb/>final bed <lb/> (a) Convergence of the cost function <lb/>(b) Convergence of the bed elevation <lb/> Fig. 3. Rectangular channel with a bump: convergence of the minimization process <lb/> can see that convergence has been achieved and the original bump on the bed <lb/>is retrieved. However, even if the shape of the bump is correctly identified, <lb/>one can notice a constant offset between the retrieved bed elevation and the <lb/>original one. This can be explained by the fact that information on the actual <lb/>water level is available neither in the formulation of the cost function nor in <lb/>the observations. There is only information on the water depth which is the <lb/>difference between the water level and the bed elevation. Therefore, the latter <lb/>can be identified only up to a constant bias. <lb/>The second experiment concerns the identification of the upstream bound-<lb/>ary condition q  in  during a flood event. We consider a 200 meters long rect-<lb/>angular channel with a constant slope of 0.5 %. The initial conditions con-<lb/>sist in a steady flow initiated by the prescription of a constant discharge of <lb/>10 m  3  s  −1  at the inlet. Flooding is created by the modification of the up-<lb/>stream boundary condition: for a period of T = 80 seconds, it is defined by <lb/>

			<note place="headnote"> A tool for variational data assimilation and adjoint sensitivity analysis <lb/></note>

			<page>7 <lb/></page>

			q  in  (t) = 10 + 5t exp <lb/> 񮽙 <lb/> −  (t−5)  2 <lb/> 100 <lb/> 񮽙 <lb/> . The corresponding hydrograph is plotted in <lb/>Fig. 4 (a). One can see the propagation of the spate in Fig. 4 (b) where the <lb/>water surface profile is displayed at several time steps. The water depth is <lb/> 0 <lb/> 10 <lb/>20 <lb/>30 <lb/>40 <lb/>50 <lb/>0 <lb/>10 <lb/>20 <lb/>30 <lb/>40 <lb/>50 <lb/>60 <lb/>70 <lb/>80 <lb/>Discharge (m <lb/> 3 <lb/> /s) <lb/> Time (s) <lb/>Upstream limit condition <lb/>0 <lb/>0.5 <lb/>1 <lb/>1.5 <lb/>2 <lb/>0 <lb/>50 <lb/>100 <lb/>150 <lb/>200 <lb/>Height (m) <lb/> Distance along x−axis (m) <lb/>free surface (t=5 s) <lb/>free surface (t=20 s) <lb/>free surface (t=35 s) <lb/>free surface (t=50 s) <lb/> (a) Upstream boundary condition <lb/>(b) Free surface evolution <lb/> Fig. 4. Rectangular channel with a constant slope: configuration <lb/> recorded continuously in time at a measurement point located at a given dis-<lb/>tance x  m  from the upstream boundary of the domain. This measurement is <lb/>used as an observation h  obs  (t) of the water depth during the flooding event. It <lb/>makes it possible to define a cost function measuring the discrepancy between <lb/>the water depth h and the observations h  obs  at the point x  m  : <lb/> j  2  (q  in  ) = <lb/>1 <lb/>2 <lb/> 񮽙  T <lb/> 0 <lb/> 񮽙 <lb/>񮽙 h(x  m  , t) − h  obs  (t) <lb/> 񮽙 <lb/>񮽙  2  dt . <lb/> (9) <lb/>From the initial hypothesis of a steady flow where the discharge is 10 m  3  s  −1  , <lb/>the experiment consists in identifying the hydrograph that is at the origin of <lb/>the spate. For that purpose, we use the variational data assimilation method. <lb/>If the point of measurement is situated near the inlet (x  m  ≤ 40 meters), the <lb/>identification of the boundary condition is very good. In Table 1, ε, the relative <lb/> L  2  error between the identified discharge and the reference discharge is given <lb/>for several values of the distance x  m  . We conclude that the efficiency of the <lb/>identification decreases when the distance of the point of measurement to the <lb/>inlet increases. <lb/>The potential of variational data assimilation applied to river hydraulics <lb/>was illustrated through two experiments. However, the tests were limited to <lb/>the case of twin experiments where uncertainty on the data and assumptions <lb/> Table 1. Relative L  2  error on the identified boundary condition for several positions <lb/>of the water depth measurement <lb/> xm <lb/> 1 m <lb/>20 m <lb/>40 m <lb/>80 m <lb/>120 m <lb/>180 m <lb/>195 m <lb/> ε <lb/> 0.45 % <lb/>0.50 % <lb/>0.53 % <lb/>2.16 % <lb/>5.21 % <lb/>8.95 % <lb/>10.1 % <lb/>

			<page> 8 <lb/></page>

			<note place="headnote"> C a s t a i n g s ,D a r t u s ,H o n n o r a t ,L eD i m e t ,L o u k i l i ,M o n n i e r <lb/></note> 
			
			on the model inputs are perfectly controlled. Assimilation of real observation <lb/>data should be further investigated. The identification of a systematic model <lb/>error would be valuable for an operational use of an hydraulic model. More-<lb/>over, the assimilation of observations of a different nature, such as trajectories <lb/>or flood marks could bring additional information for the identification of con-<lb/>trol variables. A big asset of the adjoint method is that the same adjoint code <lb/>can be used for all problems. Only the few lines of the adjoint code that cor-<lb/>respond to the computation of the cost function are to be modified, which is <lb/>very easy with an ad tool. <lb/> 4 Catchment Hydrology <lb/> Flash flood events are usually generated by heavy convective precipitation <lb/>over a relatively small area, but catchment hydrology plays a major role in <lb/>their occurrence. Thus, the transformation of rainfall into runoff is a critical <lb/>component for flash flood analysis. Recently, distributed hydrological models <lb/>became an attractive approach for the modeling of watershed hydrology. Nev-<lb/>ertheless, limited knowledge of model inputs (initial and boundary conditions, <lb/>parameters) and observations of the hydrological response make the underly-<lb/>ing problems of calibration, sensitivity analysis and uncertainty analysis very <lb/>challenging. <lb/>The underlying physics of marine, a model developed by Estupina et al. [6] <lb/>is adapted to events for which infiltration excess dominates the generation of <lb/>the flood. For the temporal and spatial scales of interest, rainfall abstraction <lb/>by infiltration is evaluated using the Green Ampt model and the resulting sur-<lb/>face runoff (hillslope flow) is transferred using the Kinematic wave approxima-<lb/>tion (kwa). Lastly, river flow is routed with the full Saint-Venant equations, <lb/>1D or 2D depending on the valley configuration. The coupling with the river <lb/>hydraulics component will not be discussed below. The simplification of mass <lb/>and momentum conservation equations representing overland flow (kwa) is <lb/>given by <lb/> ∂h <lb/> ∂t <lb/> + <lb/> s  1/2 <lb/> n <lb/> ∂h  5/3 <lb/> ∂x <lb/> = r − i , <lb/> (10) <lb/>where h is the flow depth, n the Manning roughness coefficient, s the slope <lb/>in the steepest direction, r the rainfall rate and i the infiltration rate. A pre-<lb/>liminary analysis of digital elevation model is carried out in order to compute <lb/>a single steepest descent flow direction from four available directions for each <lb/>cell. Then, (10) is solved using a simple explicit Euler scheme on the hills-<lb/>lope represented by a cascade of planes. In order to ensure convergence of <lb/>the numerical scheme, a threshold value u  m  on flow velocities was introduced. <lb/>In the right hand side term of (10) which represents the excess rainfall, the <lb/>infiltration rate i(t) is evaluated using the following procedure: <lb/>

			<note place="headnote"> A tool for variational data assimilation and adjoint sensitivity analysis <lb/></note>

			<page>9 <lb/></page>

			r &lt; i <lb/>i = r <lb/>r ≥ i <lb/>i= <lb/>dI <lb/>dt <lb/> = K <lb/> 񮽙 ψηθ <lb/> I <lb/> + 1 <lb/> 񮽙 <lb/> , <lb/> (11) <lb/>where I is the cumulative infiltration, K the hydraulic conductivity, ψ the <lb/>suction force, η the porosity and θ the relative initial moisture deficit. Equation <lb/>(11) is solved using an implicit Euler scheme, and the resulting fixed point <lb/>equation using the Newton method. <lb/> marine just like most hydrological models is far from being fully compre-<lb/>hensive and really simplify the complex hydrologic reality. In fact, improving <lb/>physical understanding would increase the number of parameters to be cali-<lb/>brated. Event and physically based models like marine are easier to set up, <lb/>have lower computational cost and require less parameters to be calibrated. <lb/>However, they have short term memory (antecedent conditions should be pro-<lb/>vided for initial soil moisture) and the prescription of consistent parameters <lb/>associated with the model formulation is a challenging task. In fact, the model <lb/>formulation is only a conceptualization of the catchment dynamics and model <lb/>parameters account for uncertainty associated to model formulation, model <lb/>structure, forcing conditions and calibration data. Therefore, effective values <lb/>for model parameters cannot be obtained from direct measurements; they <lb/>are calibrated to make model results fit available observation data. There-<lb/>fore, the potential of the adjoint method described in Sect. 2 should be in-<lb/>vestigated. However, marine just like most mathematical representations of <lb/>catchment hydrology is strongly non-linear and involve multiple thresholds or <lb/>switches due to the intrinsic nature or related conceptualization of the physical <lb/>processes (rainfall, infiltration regimes, maximum infiltration capacity, etc.). <lb/>Since introducing smoothing functions may lead to important inconsistencies <lb/>between direct and adjoint models, ad seem to be an efficient alternative <lb/>to obtain the required derivatives (i.e. sub-gradients). Hence marine adjoint <lb/>model was developed using Tapenade. After some minor code modifications, <lb/>extensive validation and optimization were carried out for the differentiated <lb/>code in order to conduce adjoint sensitivity and variational data assimilation <lb/>experiments. <lb/>The rainfall-runoff relation is a typical case where the dimension of the <lb/>system response to be analyzed is small compared to the number of input <lb/>parameters to be prescribed. In this case, the adjoint model is very efficient <lb/>in computing the gradient of a response function w.r.t. all parameters (see <lb/>Cacuci [4] for a recent theoretical basis). Obviously, the choice of the fore-<lb/>cast aspect to be analyzed will affect the analysis. However, multi-criteria <lb/>and multi-variable analysis can be carried out using the previously described <lb/>framework. A single run of the adjoint model for each criteria or response <lb/>function will yield to the local sensitivities for all parameters. <lb/>Since the objective targeted by marine is an accurate representation of <lb/>the rising limb of the flood, only the global response of the watershed (outlet <lb/>hydrograph) will be analyzed. For flash flood events, the runoff coefficient <lb/>

			<page> 10 <lb/></page>

			<note place="headnote"> Castaings, Dartus, Honnorat, Le Dimet, Loukili, Monnier <lb/></note> 
			
			and the maximum discharge are probably the most relevant quantities to be <lb/>estimated. Thus, let us define <lb/> g  1  = <lb/> 񮽙  T <lb/> 0 <lb/> q(t) dt <lb/> 񮽙  T <lb/> 0 <lb/> 񮽙  Ω <lb/> 0 <lb/> r(t) dΩ dt <lb/>g  2  = <lb/>max <lb/> t∈[0,T ] <lb/> q(t) <lb/>q  ref <lb/> , <lb/> (12) <lb/>where q(t) is the outlet discharge and q  ref  the maximum discharge obtained <lb/>when all rainfall is transformed into runoff (no infiltration). Sensitivities to g  2 <lb/> are only defined during the rising limb and vanish during recession. In fact, the <lb/>maximum discharge q  max  is calculated during the temporal integration and <lb/>when q(t) is greater than the current q  max  , temporal increments in sensitivities <lb/>correspond to sensitivities of q(t) to model parameters. In addition, from the <lb/>previously mentioned quantities, we can define g  3  , an adimensionalized and <lb/>normalized synthesis of the hydrograph: <lb/> g  3  = <lb/> g  1 <lb/> 񮽙 <lb/> g  1 2  + g  2 2 <lb/> + <lb/> g  2 <lb/> 񮽙 <lb/> g  1 2  + g  2 2 <lb/> . <lb/> (13) <lb/>The examination of the sensitivities will allow us to investigate their hydro-<lb/>logical meaning and analyze model behavior. <lb/>The chosen watershed is a very small catchment area (25 km  2  ) from the <lb/>upper part of Thoré basin. Given the basin features, no river flow routing was <lb/>considered and uniform land use and soil type is assumed in order to facil-<lb/>itate the analysis. Manning roughness coefficient n and Green Ampt model <lb/>parameters (K, ψ and η) are derived a priori from published tables using in-<lb/>formation on land use and soil type. Concerning the rainfall forcing, real radar <lb/>data (hydram from Meteo France) was lumped over the area. Since the <lb/>flow directions are computed before the model integration, accounting for the <lb/>slope s in the sensitivity analysis would lead to systematic underestimation of <lb/>its influence. Therefore, an adjoint sensitivity analysis was carried out w.r.t. <lb/>model parameters K, ψ, η, θ and n. Moreover, the response function can also <lb/>be differentiated w.r.t. numerical or algorithmic artifacts like u  m  which do not <lb/>appear neither in continuous or discretized model equations. However, ranking <lb/>the sources of uncertainty (i.e. the sensitivity of model response to parame-<lb/>ters) requires a normalization of the adjoint variables. The scaled sensitivities <lb/>are defined as <lb/> s  k  = <lb/> ∂g <lb/>∂α  k <lb/> · <lb/> α  k <lb/> g <lb/>, <lb/> (14) <lb/>with g the response function, α  k  the model parameter and s  k  the normalized <lb/>sensitivity. Since parameters are fully distributed, the L  2  norms were com-<lb/>puted in order to rank parameters influence on model response. A summary <lb/>of the obtained results is given in Table 2. One can see that u  m  which was <lb/>set to 1 ms  −1  has a greater impact on g  2  and g  3  than the calibration param-<lb/>eters. Extensive experiments were performed and show that kinematic shocks <lb/>

			<note place="headnote"> A tool for variational data assimilation and adjoint sensitivity analysis <lb/></note>

			<page>11 <lb/></page>

			occur and propagate in the flow accumulation regions (i.e. in the drainage <lb/>network) and lead to spurious velocities. Confrontations of brute force and <lb/>adjoint sensitivity analysis confirm the importance, localization and temporal <lb/>evolution of this phenomenon. In fact, using kwa, the underlying mathemat-<lb/> Table 2. Contributions (in %) of model parameters to the hydrological response <lb/> η, θ, S  f <lb/> K <lb/>n <lb/>um <lb/>g1 <lb/> 19.51 <lb/>37.57 <lb/>3.87 <lb/>3.77E-07 <lb/> g2 <lb/> 1.65 <lb/>3.10 <lb/>7.27 <lb/>84.66 <lb/> g3 <lb/> 10.20 <lb/>19.63 <lb/>4.32 <lb/>45.41 <lb/> ical model is still non-linear and the occurrence of shocks seem inescapable <lb/>specially when the complex watershed topography is represented by a cas-<lb/>cade of planes. Therefore, appropriate shock fitting methods should be used <lb/>in order to ensure that the numerical approximation of the kinematic wave <lb/>does not dominate the parameter calibration issue. On the other hand, the <lb/>results obtained with response function g  1  show that effect of this threshold <lb/>on the runoff coefficient can be neglected and that the partition of rainfall into <lb/>runoff and infiltration is mainly driven by hydraulic conductivity K. More-<lb/>over, it was shown that the wetter the soil is, the shorter is the decay of i <lb/> to K and the larger is the influence of parameter K. In addition, a detailed <lb/>analysis of the spatial and temporal patterns of the obtained sensitivities re-<lb/>ally provide physical insight into the model dynamics. In fact, all the cells of <lb/>the watershed are solicited for infiltration from both direct rainfall and ex-<lb/>cess rainfall coming from upstream in the basin (run-on). The latter seems to <lb/>be critical since the spatial pattern of sensitivity to all Green Ampt infiltra-<lb/>tion parameters is driven by the drainage network. For example, one can see <lb/>in Fig. 5 the correspondence between slopes and sensitivity to K. Moreover, <lb/> (a) DTM slopes <lb/>(b) Sensitivity to K <lb/> Fig. 5. Sensitivity to infiltration parameters and catchment slopes <lb/> Fig. 6 exhibits the temporal patterns of the sensitivities to model parameters. <lb/>The thresholds related to rainfall dynamics and different infiltration regimes <lb/>

			<page> 12 <lb/></page>

			<note place="headnote"> Castaings, Dartus, Honnorat, Le Dimet, Loukili, Monnier <lb/></note> 
			
			lead to similar thresholds on temporal increments of adjoint variables. One <lb/>can see in Fig. 6 that the event was divided into four periods and once again <lb/>the results are in agreement with the infiltration excess overland flow mech-<lb/>anism. In fact, during period 1, rainfall totally infiltrates to the unsaturated <lb/>zone without intervention of model parameters. Then, once rainfall intensity <lb/>becomes important (beginning of period 2) the infiltration from direct rain-<lb/>fall is immediate and run-on develops. This can be noticed by the rising of <lb/>the sensitivity to n. During period 2, rainfall duration and intensity remain <lb/>limited and do not produce rising of the hydrograph. On the contrary dur-<lb/>ing period 3, rainfall is so intense and its duration so important that a large <lb/>amount of runoff is produced. The runoff coefficient and associated statistical <lb/>moments were computed (mean and variance) and showed thats during this <lb/>period the runoff coefficient is very close to unity on the whole watershed. <lb/>Therefore, the global influence of K remains constant and the sensitivity of <lb/>other infiltration parameters decreases as the cumulative infiltration increases. <lb/>At last, once intense rainfall stops, run-on produces infiltration mainly in the <lb/>drainage network and progressively decreases. <lb/> 0 <lb/> 20 <lb/>40 <lb/>60 <lb/>80 <lb/>100 <lb/>120 <lb/>140 <lb/>160 <lb/>180 <lb/>200 <lb/>0 <lb/>10000 <lb/>20000 <lb/>30000 <lb/>40000 <lb/>50000 <lb/>60000 <lb/>70000 <lb/>0 <lb/>20 <lb/>40 <lb/>60 <lb/>80 <lb/>100 <lb/>120 <lb/>140 <lb/>discharge (m^3/s) <lb/> rainfall (mm/h) <lb/> time (s) <lb/>Outlet flood hydrograph <lb/>rainfall <lb/>discharge <lb/> 1e-16 <lb/>1e-14 <lb/>1e-12 <lb/>1e-10 <lb/>1e-08 <lb/>1e-06 <lb/>1e-04 <lb/>0.01 <lb/>0 <lb/>10000 <lb/>20000 <lb/>30000 <lb/>40000 <lb/>50000 <lb/>60000 <lb/>70000 <lb/>0 <lb/>20 <lb/>40 <lb/>60 <lb/>80 <lb/>100 <lb/>120 <lb/>140 <lb/> sensitivity <lb/> rainfall (mm/h) <lb/> time (s) <lb/>Temporal evolution of parameter sensitivities <lb/>rainfall <lb/>K <lb/> η,θ,Sf <lb/> n <lb/> 1 <lb/> 4 <lb/>2 <lb/>3 <lb/> (a) Outlet hydrograph <lb/>(b) Temporal patterns of sensitivities <lb/> Fig. 6. Sensitivity to parameters and flood hydrograph <lb/> For the considered test case, the potential of the adjoint sensitivity proce-<lb/>dure was demonstrated for model diagnostic and sensitivity analysis. However, <lb/>the behavior of the hydrosystem is analyzed only locally in the parameter <lb/>space around effective values of model parameters and lead to sensitivities for <lb/>a single point of the surface response. The influence of the point chosen for <lb/>this local sensitivity analysis should be investigated in order to draw more <lb/>general conclusions. Indeed, results may depend on the type of soil, on the ra-<lb/>tio between rainfall intensity (also duration) and hydraulic conductivity. The <lb/>contribution of some form of global sensitivity analysis should be examined. <lb/>The development of automatic calibration methods received much attention <lb/>from hydrologic community, but problems of differentiability, parameter in-<lb/>sensitivity, parameters interactions and multiple local optima make the use <lb/>of gradient based methods very difficult. However, even if the temporal in-<lb/>crements of adjoint variables exhibit non-differentiable features, sensitivities <lb/>

			<note place="headnote"> A tool for variational data assimilation and adjoint sensitivity analysis <lb/></note>

			<page>13 <lb/></page>

			of the global and smooth hydrological response to temporally integrated sen-<lb/>sitivities should not. Systematic preliminary sensitivity analysis should also <lb/>be carried out in order to identify the key parameters which really affect the <lb/>chosen hydrological response. This should prevent from flat portions of sur-<lb/>face response (i.e. low sensitivities for one direction of the parameter space). <lb/>From the observed trends, a multi-criteria calibration strategy could be de-<lb/>veloped in order to adjust some of the parameters for a given aspect of the <lb/>response. Such investigations are in progress and require appropriate regular-<lb/>ization approaches and strategies for the reduction of the control space to be <lb/>developed. Then, the well posed inverse problem can be solved using standard <lb/>unconstrained optimization methods. <lb/> 5 Conclusion <lb/> The adjoint method is a very efficient and flexible mathematical tool to calcu-<lb/>late derivatives of a function of model state variable w.r.t. control variables. <lb/>Two applications for flood modeling were presented in this prospective study. <lb/>Variational data assimilation allows the identification of model parameters, <lb/>initial and boundary conditions. Adjoint sensitivity analysis provides knowl-<lb/>edge of the contribution of model inputs to the variations of some features of <lb/>the solution, as well as a physical insight into the model dynamics. <lb/>The practical implementation of the adjoint method is significantly facili-<lb/>tated by the use of efficient ad tools like Tapenade. The development time is <lb/>considerably reduced and many human errors are avoided. However, with the <lb/>current version of the tool, it is still necessary to manually modify the adjoint <lb/>code to make it work properly. Unnecessary storage of variables can make <lb/>the code require too much memory and the adjoint of some non-differentiable <lb/>statements need to be manually fixed. <lb/>Nevertheless, ad remains a very powerful technique used for the achieve-<lb/>ment of the adjoint method. It opens new trends for the construction of an <lb/>hydro-meteorological prediction chain and for future contributions concerning <lb/>flood hazard forecast and mitigation. <lb/></body>

		<back>
			<listBibl> References <lb/> 1. F. Bouttier and P. Courtier. Data assimilation concepts and methods. Meteo-<lb/>rological Training Course Lecture Series, Ecmwf, 1999. <lb/>2. D.G. Cacuci. Sensitivity theory for nonlinear systems. I. Nonlinear functional <lb/>analysis approach. J. Math. Phys., 22(12):2794–2802, 1981. <lb/>3. D.G. Cacuci. Sensitivity theory for nonlinear systems. II. Extensions to addi-<lb/>tional classes of responses. J. Math. Phys., 22(12):2803–2812, 1981. <lb/>4. D.G. Cacuci. Sensitivity and Uncertainty Analysis, Volume I Theory. Chapman <lb/>&amp; Hall/CRC, 2003. <lb/>

			<page> 14 <lb/></page>

			<note place="headnote"> Castaings, Dartus, Honnorat, Le Dimet, Loukili, Monnier <lb/></note>
			
			5. F.-X. Le Dimet and O. Talagrand. Variational algorithms for analysis and <lb/>assimilation of meteorogical observations. Tellus, 38A:97–110, 1986. <lb/>6. V. Estupina-Borrell, M.M. Maubourguet, J. Chorda, M. Alquier, and D. Dartus. <lb/>Use of direct simulation whith space technology for flash flood events analysis. <lb/> Ecosystems and Floods,Hano¨  ages 72–87, 2000. <lb/>7. J.-C. Gilbert and C. Lemaréchal. Some numerical experiments with variable <lb/>storage quasi-Newton algorithms. Mathematical programming, 45:407–435, 1989. <lb/>8. L. Hascoët, R.-M. Greborio, and V. Pascual. Computing adjoints by automatic <lb/>differentiation with tapenade. In  <lb/>Ecole INRIA-CEA-EDF &quot; Proì emes non-<lb/>linéaires appliqués &quot; . Springer, 2003. To appear. <lb/>9. L. Hascoët, V. Pascual, and R.-M. Greborio. The Tapenade AD tool, Tropics <lb/> Project, INRIA Sophia-Antipolis. AD Workshop, Cranfield, June 5-6, 2003. <lb/>10. J.-L. Lions. Optimal control of systems governed by partial differential equations. <lb/> Springer-Verlag, 1971. <lb/>11. Y. Loukili and A. Soula¨ mani. Numerical tracking of shallow water waves by <lb/>the unstructured Finite Volume WAF approximation. Journal of Computational <lb/>Methods in Sciences and Engineering, to appear, 2004. <lb/>12. C. Mazauric. Data assimilation for hydraulic models. Parameters estimation, <lb/>sensitivity analysis and domain decomposition. PhD thesis, Université Joseph <lb/>Fourier (Grenoble), 2003. In french. <lb/>13. P. Ngnepieba, F.-X. Le Dimet, A. Boukong, and G. Nguetseng. Inverse problem <lb/>formulation for parameters determination using the adjoint method. ARIMA <lb/>Journal -Revue Africaine de la Recherche in Informatique et Mathématiques <lb/>Appliquées, 1:127–157, 2002. <lb/>14. Inria, Tropics Project. Tapenade 2.0. <lb/> &lt;http://www-sop.inria.fr/tropics/&gt;. <lb/> 15. E.F. Toro. Shock-capturing methods for free-surface shallow flows. J. Wiley and <lb/>Sons, Chichester, 2001. <lb/>16. P.A. Vidard, A. Piacentini, and F.-X. Le Dimet. Variational data analysis with <lb/>control of the forecast bias. Tellus, 56A(3):177–188, 2004. <lb/>17. L.W. White, B. Vieux, D. Armand, and F.-X. Le Dimet. Estimation of opti-<lb/>mal parameters for a surface hydrology model. Advances in Water Resources, <lb/> 26(3):337–348, 2003. <lb/>18. J. Yang. Variational data assimilation for the problems of sediment transport in <lb/>rivers. PhD thesis, Université Joseph Fourier (Grenoble), 1999. In french. </listBibl>

		</back>
	</text>
</tei>
